<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hey taxi! Car Tracker</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <nav class="col p-2 g-3 navbar">
      <div class="col-2">
        <a href=""><button class="logo">hey!</button></a>
      </div>

      <div class="col user col-2">
        <div class="p text-white user-username">Car Tracker</div>
        <div>
          <a href="#"
            ><img src="./pics/Untitled.png" alt="user-img" id="user-img"
          /></a>
        </div>
      </div>
    </nav>
    <div class="space"></div>
    <div>
      <div class="col" id="map-container">
        <div class="col-12" id="map"></div>
      </div>
    </div>
    <div class="location-list-container">
      <h2>Recent Visited Locations</h2>
      <ul id="visitedLocationsList">
        <li>Loading locations...</li>
      </ul>
    </div>
    <div class="row footer bg-dark mt-3 py-3 border-round" id="footer">
      <div class="row text-center text-white">
        <p class="display-7">a website by kian ghaffarian and omid hamidian</p>
        <small class="text-white-30"> special thanks to mr.mahmoodzadeh</small>
      </div>
    </div>

    <img src="./pics/doom.png" alt="" class="music-image" id="audioImage" />
    <audio id="myAudio" src="./doom.mp3"></audio>

    <script>
      let map;
      let carMarker;
      let locationMarkers = L.featureGroup();
      let initialMapCenter = [36.2972, 59.6067];

      map = L.map("map").setView(initialMapCenter, 15);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      carMarker = L.marker(initialMapCenter).addTo(map);
      carMarker.bindPopup("Car's Current Location").openPopup();

      locationMarkers.addTo(map);

      const geocodeCache = {};

      async function reverseGeocode(latitude, longitude) {
        const cacheKey = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
        if (geocodeCache[cacheKey]) {
          return geocodeCache[cacheKey];
        }

        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;

        try {
          const response = await fetch(nominatimUrl);
          const data = await response.json();
          const locationName = data.display_name || "Unknown Location";
          geocodeCache[cacheKey] = locationName;
          return locationName;
        } catch (error) {
          console.error("Error during Nominatim reverse geocoding:", error);
          return "Error Fetching Location Name";
        }
      }

      async function fetchAndDisplayLocations() {
        try {
          const response = await fetch("/locations");
          const locations = await response.json();

          if (locations.length === 0) {
            console.log("No car location data available.");
            document.getElementById("visitedLocationsList").innerHTML =
              "<li>No location history available.</li>";
            return;
          }

          locationMarkers.clearLayers();

          const latestLocation = locations[locations.length - 1];
          carMarker.setLatLng([
            latestLocation.latitude,
            latestLocation.longitude,
          ]);
          carMarker.setPopupContent(
            `Car's Current Location<br>(${latestLocation.latitude.toFixed(
              4
            )}, ${latestLocation.longitude.toFixed(
              4
            )})<br>Last Updated: ${new Date(
              latestLocation.timestamp
            ).toLocaleString()}`
          );

          locations.forEach((loc, index) => {
            let markerSize = 15;
            if (index === locations.length - 1) {
              markerSize = 30;
            } else if (index === locations.length - 2) {
              markerSize = 25;
            } else if (index === locations.length - 3) {
              markerSize = 20;
            }

            let customIcon = L.divIcon({
              className: "custom-marker",
              html: `<div style="background-color: red; width: ${markerSize}px; height: ${markerSize}px; border-radius: 50%;"></div>`,
              iconSize: [markerSize, markerSize],
              iconAnchor: [markerSize / 2, markerSize / 2],
            });

            const marker = L.marker([loc.latitude, loc.longitude], {
              icon: customIcon,
            });
            marker.bindPopup(
              `Location: (${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(
                4
              )})<br>Time: ${new Date(loc.timestamp).toLocaleString()}`
            );
            locationMarkers.addLayer(marker);
          });

          console.log("Map updated with new locations and markers.");

          const locationsListElement = document.getElementById(
            "visitedLocationsList"
          );
          locationsListElement.innerHTML = "";

          const locationsToGeocode = [];
          const uniqueLocations = new Set();

          for (
            let i = locations.length - 1;
            i >= 0 && locationsToGeocode.length < 10;
            i--
          ) {
            const loc = locations[i];
            const locString = `${loc.latitude.toFixed(
              4
            )},${loc.longitude.toFixed(4)}`;
            if (!uniqueLocations.has(locString)) {
              locationsToGeocode.unshift(loc);
              uniqueLocations.add(locString);
            }
          }

          if (locationsToGeocode.length === 0) {
            locationsListElement.innerHTML =
              "<li>No unique recent locations to display.</li>";
          } else {
            for (const loc of locationsToGeocode) {
              const locationName = await reverseGeocode(
                loc.latitude,
                loc.longitude
              );
              const listItem = document.createElement("li");
              listItem.innerHTML = `<strong>${new Date(
                loc.timestamp
              ).toLocaleString()}</strong>: ${locationName} <em>(${loc.latitude.toFixed(
                4
              )}, ${loc.longitude.toFixed(4)})</em>`;
              locationsListElement.appendChild(listItem);
            }
          }
        } catch (error) {
          console.error("Error fetching car locations:", error);
        }
      }

      fetchAndDisplayLocations();

      setInterval(fetchAndDisplayLocations, 10000);

      const audio = document.getElementById("myAudio");
      const image = document.getElementById("audioImage");

      let isPlaying = false;

      image.addEventListener("click", () => {
        if (!isPlaying) {
          audio.play();
        } else {
          audio.pause();
          audio.currentTime = 0;
        }
        isPlaying = !isPlaying;
      });

      audio.addEventListener("ended", () => {
        isPlaying = false;
      });
    </script>
  </body>
</html>
